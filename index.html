<html>
<head>
<title> BraggingRights </title>

<link rel="STYLESHEET" type="text/css" href="dhtmlx/dhtmlxGrid/codebase/dhtmlxgrid.css">
<link rel="stylesheet" type="text/css" href="dhtmlx/dhtmlxGrid/codebase/skins/dhtmlxgrid_dhx_skyblue.css">

<script src="dhtmlx/dhtmlxGrid/codebase/dhtmlxcommon.js"></script>
<script src="dhtmlx/dhtmlxGrid/codebase/dhtmlxgrid.js"></script>
<script src="dhtmlx/dhtmlxGrid/codebase/dhtmlxgridcell.js"></script>

<script src="tabletop.js"></script>

<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
  
<link  href="http://fonts.googleapis.com/css?family=Cherry+Cream+Soda:regular&v1" rel="stylesheet" type="text/css" >
<style>
body {
	background-color: #a0e0ff;
}	
h1 {
  text-align: center;
  font-family: 'Cherry Cream Soda', serif;
  font-size: 48px;
  font-style: normal;
  font-weight: 700;
  text-shadow: 3px 3px 3px #aaa;
  text-decoration: none;
  text-transform: capitalize;
  letter-spacing: 0em;
  word-spacing: 0em;
  line-height: 1.2;
}
.sans {
  font-family: sans-serif;
  font-size: 16;
  font-style: italic;
}
</style>

</head>

<body>

<H1> Bragging Rights </H1>
<p class="sans">
What North American city has won the most major sports championships?

<center>
<div id="brGrid" style="width:650;height:450px"></div>
</center>
<p>
<a href="https://docs.google.com/spreadsheets/d/1FjlM88FTZbc3c7-bYJxsmqd0eVvG5vVmC4QObXYwrB0/pubhtml"> Current data </a>

<div id="brCityPopup" title="Bragging Rights">
  <div id="cbrGrid" style="width:500px"></div> 
</div>



<script type="text/javascript">

	$(document).ready(function() {
		$('#brCityPopup').dialog({ autoOpen: false, width: "auto", autoResize: true });

	  var cbrGrid = new dhtmlXGridObject('cbrGrid');
	  cbrGrid.setImagePath("dhtmlx/dhtmlxGrid/codebase/imgs/");
	  cbrGrid.setHeader("Year,Sport,Result,Winner,Loser");
	  cbrGrid.setInitWidths("50,50,50,120,120");
	  cbrGrid.setColAlign("center,center,center,center,center");
	  cbrGrid.setColTypes("ro,ro,ro,ro,ro");
	  cbrGrid.setColSorting("str,str,str,str,str");
	  cbrGrid.init();
	  cbrGrid.setSkin("dhx_skyblue");

	  var brGrid = new dhtmlXGridObject('brGrid');
	  brGrid.setImagePath("dhtmlx/dhtmlxGrid/codebase/imgs/");
	  brGrid.setHeader(",Championships,#cspan,MLB,#cspan,NFL,#cspan,NBA,#cspan,NHL,#cspan");
	  brGrid.attachHeader("City,Wins,Losses,wins,losses,wins,losses,wins,losses,wins,losses",["text-align:center;","text-align:center;","text-align:center", "text-align:center;","text-align:center", "text-align:center;","text-align:center", "text-align:center;","text-align:center" ]);
	  brGrid.setInitWidths("130,50,50,50,50,50,50,50,50,50,50");
	  brGrid.setColAlign("center,center,center,center,center,center,center,center,center,center,center");
	  brGrid.setColTypes("ro,ro,ro,ro,ro,ro,ro,ro,ro,ro,ro,ro");
	  brGrid.setColSorting("str,int,int,int,int,int,int,int,int,int,int");
	  brGrid.init();
	  brGrid.setSkin("dhx_skyblue");
	  brGrid.attachEvent("onRowSelect", function brGridRowSelectEvent(i,ind){
        citySelect(i, ind, cbrGrid);
    });

    // from Google doc, see 'publish' menu item
    var BrKey = "1FjlM88FTZbc3c7-bYJxsmqd0eVvG5vVmC4QObXYwrB0";
    // https://github.com/jsoma/tabletop
    var t = Tabletop.init( { key: BrKey, simpleSheet: true,
                   callback: function(data, tabletop) { 
                      //console.log(data);
                      ttCallback(tabletop, brGrid);
                    } 
                  } );
	});

  // globals...
  var tN = new Object; // sport per city, wins/losses
  var qall = new Object; // convenience for all sports per city
  var ct = new Object;		// props map teams to cities
	var carray = new Array;		// just list of cities

  function getSport ( sport, br ) {
	  var q = new Object;   // per sport
	  tN[sport] = q;

		br.forEach(function(x) { // add up each city count
		  var c = x.winner; 
		  if (! ct.hasOwnProperty(c)) {
        console.log("ct doesn't have city ", c);
      }
		  c = ct[c];
		  if (! q.hasOwnProperty(c)) {
			  q[c] = new Object ; q[c].wins=0; q[c].losses=0; 
			  q[c].text = "";
		  } 
		  q[c].wins += 1; q[c].text+=x.year+": "+x.winner+" Won ";
		  if (! qall.hasOwnProperty(c)) { 
			  qall[c] = new Object ; qall[c].wins=0; qall[c].losses=0; 
			  qall[c].a = [];
		  } 
		  qall[c].wins += 1;
		  qall[c].a.push( [ x.year, sport, "Won", x.winner, x.loser ] );
    
		  c = x.loser; 
		  if (! ct.hasOwnProperty(c)) {
        console.log("ct doesn't have city ", c);
      }
		  c = ct[c];
		  if (!q.hasOwnProperty(c)) { 
			  q[c] = new Object ; q[c].wins=0; q[c].losses=0; 
			  q[c].text = "";
		  } 
		  q[c].losses += 1; q[c].text+=x.year+": "+x.loser+" Lost "; 
		  if (!qall.hasOwnProperty(c)) { 
			  qall[c] = new Object ; qall[c].wins=0; qall[c].losses=0; 
			  qall[c].a = [];
		  }
		  qall[c].losses += 1;
		  qall[c].a.push( [ x.year, sport, "Lost", x.winner, x.loser ] );
	  });
  }

  function getT( sport, city, s ) {
	  var y = tN[sport];
	  if (y.hasOwnProperty(city)) { 
		  var z = y[city];
		  return z[s];
	  } else {
		  return 0;
	  }
  }

  function ttCallback( tabletop, brGrid ) {
    var BrCities = tabletop.sheets('cities').elements;
    var BrMLB = tabletop.sheets('mlb').elements;
    var BrNFL = tabletop.sheets('nfl').elements;
    var BrNBA = tabletop.sheets('nba').elements;
    var BrNHL = tabletop.sheets('nhl').elements;

    // get Cities/Teams data
    var clist = new Object;		// just list of cities
  	tN["all"] = qall; 

    BrCities.map(function(x) {
      ct[x.team] = x.city;
    });
    for (var e in ct) {
      clist[ct[e]]=1;
    }
	  for (var e in clist) {
	  	carray.push(e);
	  }

	  getSport ( "mlb", BrMLB );
	  getSport ( "nfl", BrNFL );
	  getSport ( "nba", BrNBA );
	  getSport ( "nhl", BrNHL );

	  var da = [];
	  for (var c in clist) { 
		  da.push( [ c, getT("all",c,"wins"), getT("all",c,"losses"), getT("mlb",c,"wins"), getT("mlb",c,"losses"), getT("nfl",c,"wins"), getT("nfl",c,"losses"), getT("nba",c,"wins"), getT("nba",c,"losses"), getT("nhl",c,"wins"), getT("nhl",c,"losses") ] );
	  };

	  // publish
	  brGrid.parse(da,"jsarray"); 
	  brGrid.sortRows(1,"int","des");
	}

  function citySelect ( id, ind, grid ) {
	  c = carray[id-1];
	  grid.clearAll();
	  grid.parse(qall[c].a,"jsarray"); 
	  d=$('#brCityPopup');
	  d.dialog( "option", "title", "Bragging Rights: " + c );
	  d.dialog('open');
  }
</script>	
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-64211034-1', 'auto');
  ga('send', 'pageview');

</script>

</body
</html>
